<div class="container" *ngIf="!isLoading && !error && order">
  <app-breadcrumb [items]="breadcrumbItems"></app-breadcrumb>

  <div class="main-header">
    <h1 class="page-title">Order #{{order.id}}</h1>
    <div class="actions">
      <button mat-raised-button color="primary" (click)="printOrder()">
        <mat-icon>print</mat-icon>
        Print Order
      </button>
    </div>
  </div>

  <div class="order-grid">
    <!-- Order Details -->
    <mat-card class="order-details-card">
      <mat-card-header>
        <mat-card-title>Order Details</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="detail-row">
          <span class="detail-label">Order ID:</span>
          <span class="detail-value">{{order.id}}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Date:</span>
          <span class="detail-value" *ngIf="order.date && order.date !== '0000-00-00'">{{order.date | date:'medium'}}</span>
          <span class="detail-value" *ngIf="!order.date || order.date === '0000-00-00'">{{order.created_at | date:'medium'}}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Status:</span>
          <span class="status-chip" [ngClass]="getStatusChipClass(order.statusId)">
            {{order.statusName || order.status || 'Unknown'}}
          </span>
        </div>
        <div class="status-update">
          <mat-form-field appearance="fill">
            <mat-label>Update Status</mat-label>
            <mat-select [(ngModel)]="selectedStatus">
              <mat-option *ngFor="let status of orderStatuses" [value]="status.id">
                {{status.status}}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <button mat-raised-button
                  color="primary"
                  class="status-update-btn"
                  [disabled]="selectedStatus === order.statusId.toString()"
                  (click)="updateOrderStatus()">
            Update Status
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Customer Information -->
    <mat-card class="customer-card">
      <mat-card-header>
        <mat-card-title>Customer Information</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="detail-row">
          <span class="detail-label">Name:</span>
          <span class="detail-value">{{order.name || 'N/A'}}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Email:</span>
          <span class="detail-value">{{order.email || 'N/A'}}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Phone:</span>
          <span class="detail-value">{{order.phoneNumber || 'N/A'}}</span>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Shipping Information -->
    <mat-card class="shipping-card">
      <mat-card-header>
        <mat-card-title>Shipping Information</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="detail-row">
          <span class="detail-label">Address:</span>
          <span class="detail-value">{{order.address || 'N/A'}}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">State:</span>
          <span class="detail-value">{{order.state || 'N/A'}}</span>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Order Items -->
  <mat-card class="order-items-card">
    <mat-card-header>
      <mat-card-title>Order Items</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <table mat-table [dataSource]="orderItems" *ngIf="orderItems && orderItems.length > 0; else noItems">
        <!-- Image Column -->
        <ng-container matColumnDef="image">
          <th mat-header-cell *matHeaderCellDef>Image</th>
          <td mat-cell *matCellDef="let item">
            <div class="product-image">
              <img *ngIf="item.imgOne" [src]="item.imgOne" alt="Product image">
              <img *ngIf="!item.imgOne && item.image" [src]="item.image" alt="Product image">
              <div *ngIf="!item.imgOne && !item.image" class="no-image">No Image</div>
            </div>
          </td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Product</th>
          <td mat-cell *matCellDef="let item">{{item.title || item.name || item.productName || 'N/A'}}</td>
        </ng-container>

        <!-- Price Column -->
        <ng-container matColumnDef="price">
          <th mat-header-cell *matHeaderCellDef>Price</th>
          <td mat-cell *matCellDef="let item">
            <ng-container *ngIf="getProductPrice(item) > 0">
              {{getProductPrice(item) | addSpaceAfterCurrency}}
            </ng-container>
            <ng-container *ngIf="getProductPrice(item) <= 0">N/A</ng-container>
          </td>
        </ng-container>

        <!-- Quantity Column -->
        <ng-container matColumnDef="quantity">
          <th mat-header-cell *matHeaderCellDef>Quantity</th>
          <td mat-cell *matCellDef="let item">{{getProductQuantity(item) || 'N/A'}}</td>
        </ng-container>

        <!-- Total Column -->
        <ng-container matColumnDef="total">
          <th mat-header-cell *matHeaderCellDef>Total</th>
          <td mat-cell *matCellDef="let item">
            <ng-container *ngIf="getProductTotal(item) > 0">
              {{getProductTotal(item) | addSpaceAfterCurrency}}
            </ng-container>
            <ng-container *ngIf="getProductTotal(item) <= 0">N/A</ng-container>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <ng-template #noItems>
        <div class="no-items-message">No items available for this order</div>
      </ng-template>

      <div class="order-summary" *ngIf="orderItems && orderItems.length > 0">
        <div class="summary-row">
          <span class="summary-label">Subtotal:</span>
          <span class="summary-value">
            <ng-container *ngIf="order?.subtotal">
              {{order.subtotal | currency:'EGP':'symbol':'1.2-2' | addSpaceAfterCurrency}}
            </ng-container>
            <ng-container *ngIf="!order?.subtotal">
              {{calculateSubtotal() | currency:'EGP':'symbol':'1.2-2' | addSpaceAfterCurrency}}
            </ng-container>
          </span>
        </div>
        <div class="summary-row" *ngIf="order?.shippingCost || order?.shipping">
          <span class="summary-label">Shipping:</span>
          <span class="summary-value">
            <ng-container *ngIf="order?.shippingCost">
              {{order.shippingCost | currency:'EGP':'symbol':'1.2-2' | addSpaceAfterCurrency}}
            </ng-container>
            <ng-container *ngIf="!order?.shippingCost && order?.shipping">
              {{order.shipping | currency:'EGP':'symbol':'1.2-2' | addSpaceAfterCurrency}}
            </ng-container>
          </span>
        </div>
        <div class="summary-row" *ngIf="order?.discount">
          <span class="summary-label">Discount:</span>
          <span class="summary-value">{{order.discount |   currency:'EGP':'symbol':'1.2-2' | addSpaceAfterCurrency}}</span>
        </div>
        <div class="summary-row total-row">
          <span class="summary-label">Total:</span>
          <span class="summary-value">
            <ng-container *ngIf="order?.total">
              {{order.total | currency:'EGP':'symbol':'1.2-2' | addSpaceAfterCurrency}}
            </ng-container>
            <ng-container *ngIf="!order?.total">
              {{calculateTotal() | currency:'EGP':'symbol':'1.2-2' | addSpaceAfterCurrency}}
            </ng-container>
          </span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<div class="loading-container" *ngIf="isLoading">
  <mat-spinner diameter="50"></mat-spinner>
</div>

<div class="error-message" *ngIf="error">
  <p>{{error}}</p>
  <button mat-raised-button color="primary" (click)="tryAgain()">Try Again</button>
</div>
